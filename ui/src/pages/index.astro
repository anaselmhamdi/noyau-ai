---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import SubscribeForm from '../components/SubscribeForm.astro';
import DigestPreview from '../components/DigestPreview.astro';
import HowItWorks from '../components/HowItWorks.astro';
import { generateOrganizationSchema, generateWebSiteSchema } from '../lib/schema';

export const prerender = false;

let latestDate = new Date().toISOString().split('T')[0];
let previewItems: Array<{ rank: number; headline: string; teaser: string }> = [];

try {
  const apiUrl = process.env.API_URL || '';
  const res = await fetch(`${apiUrl}/api/issues/latest`);
  if (res.ok) {
    const data = await res.json();
    latestDate = data.date || latestDate;
    previewItems = (data.items || []).slice(0, 3).map((item: any) => ({
      rank: item.rank,
      headline: item.headline,
      teaser: item.teaser,
    }));
  }
} catch {}

const organizationSchema = generateOrganizationSchema();
const webSiteSchema = generateWebSiteSchema();
---

<BaseLayout
  title="noyau"
  description="10 things worth knowing. Daily engineering digest for practical tech news. No fluff, just actionable intelligence for builders."
  canonicalUrl="https://noyau.news"
>
  <Fragment slot="structured-data">
    <script type="application/ld+json" set:html={JSON.stringify(organizationSchema)} />
    <script type="application/ld+json" set:html={JSON.stringify(webSiteSchema)} />
  </Fragment>

  <Header slot="header" />

  {/* Hero Section */}
  <section class="relative py-20 sm:py-28 lg:py-32 overflow-hidden">
    {/* Background accent */}
    <div class="absolute inset-0 pointer-events-none">
      <div class="absolute top-1/4 left-1/2 -translate-x-1/2 w-[600px] h-[600px] bg-signal/5 rounded-full blur-3xl"></div>
    </div>

    <div class="container relative">
      {/* Logo mark animation */}
      <div class="flex justify-center mb-8 opacity-0 animate-fade-in">
        <div class="flex items-center gap-1 text-2xl">
          <span class="text-muted font-mono">[</span>
          <span class="w-3 h-3 bg-signal rounded-full animate-pulse-subtle"></span>
          <span class="text-muted font-mono">]</span>
        </div>
      </div>

      {/* Headline */}
      <div class="text-center max-w-2xl mx-auto">
        <h1 class="text-display text-text text-balance opacity-0 animate-fade-in-up" style="animation-delay: 100ms">
          The kernel brief<br />
          <span class="text-gradient">for builders</span>
        </h1>

        <p class="mt-6 text-h2 font-normal text-muted opacity-0 animate-fade-in-up" style="animation-delay: 200ms">
          10 ranked tech stories. Every morning. No fluff.
        </p>

        {/* Subscribe form */}
        <div class="mt-10 opacity-0 animate-fade-in-up" style="animation-delay: 300ms">
          <SubscribeForm variant="hero" />
        </div>

        {/* Micro-features */}
        <div class="mt-8 flex flex-wrap items-center justify-center gap-x-6 gap-y-2 opacity-0 animate-fade-in" style="animation-delay: 500ms">
          <span class="flex items-center gap-2 text-micro text-muted">
            <svg class="w-4 h-4 text-good" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Free forever
          </span>
          <span class="flex items-center gap-2 text-micro text-muted">
            <svg class="w-4 h-4 text-good" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            No spam
          </span>
          <span class="flex items-center gap-2 text-micro text-muted">
            <svg class="w-4 h-4 text-good" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Unsubscribe anytime
          </span>
        </div>
      </div>

      {/* Scroll indicator */}
      <div class="mt-16 flex justify-center opacity-0 animate-fade-in" style="animation-delay: 700ms">
        <a
          href="#preview"
          class="flex flex-col items-center gap-2 text-muted hover:text-signal transition-colors group"
        >
          <span class="text-micro font-mono">See today's digest</span>
          <svg class="w-5 h-5 animate-bounce" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
          </svg>
        </a>
      </div>
    </div>
  </section>

  {/* Preview Section */}
  <div id="preview">
    {previewItems.length > 0 ? (
      <DigestPreview items={previewItems} date={latestDate} />
    ) : (
      <section class="py-16 sm:py-20">
        <div class="container text-center">
          <p class="text-muted">Loading latest digest...</p>
        </div>
      </section>
    )}
  </div>

  {/* How It Works Section */}
  <HowItWorks />

  {/* Bottom CTA */}
  <section class="py-16 sm:py-20">
    <div class="container">
      <div class="card text-center py-12 sm:py-16">
        <h2 class="text-h1 text-text mb-4">
          Ready to cut through the noise?
        </h2>
        <p class="text-body text-muted mb-8 max-w-md mx-auto">
          Join engineers who start their day with signal, not noise.
        </p>
        <SubscribeForm variant="hero" />
      </div>
    </div>
  </section>

  <Footer slot="footer" />
</BaseLayout>
