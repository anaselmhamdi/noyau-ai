---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import SubscribeForm from '../components/SubscribeForm.astro';
import DigestPreview from '../components/DigestPreview.astro';
import HowItWorks from '../components/HowItWorks.astro';
import { generateOrganizationSchema, generateWebSiteSchema } from '../lib/schema';

export const prerender = false;

let latestDate = new Date().toISOString().split('T')[0];
let previewItems: Array<{ rank: number; headline: string; teaser: string }> = [];

try {
  const apiUrl = process.env.API_URL || '';
  const res = await fetch(`${apiUrl}/api/issues/latest`);
  if (res.ok) {
    const data = await res.json();
    latestDate = data.date || latestDate;
    previewItems = (data.items || []).slice(0, 3).map((item: any) => ({
      rank: item.rank,
      headline: item.headline,
      teaser: item.teaser,
    }));
  }
} catch {}

const organizationSchema = generateOrganizationSchema();
const webSiteSchema = generateWebSiteSchema();
---

<BaseLayout
  title="noyau"
  description="10 things worth knowing. Daily engineering digest for practical tech news. No fluff, just actionable intelligence for builders."
  canonicalUrl="https://noyau.news"
>
  <Fragment slot="structured-data">
    <script type="application/ld+json" set:html={JSON.stringify(organizationSchema)} />
    <script type="application/ld+json" set:html={JSON.stringify(webSiteSchema)} />
  </Fragment>

  <Header slot="header" />

  {/* Hero Section */}
  <section class="relative py-20 sm:py-28 lg:py-32 overflow-hidden">
    {/* Background accent */}
    <div class="absolute inset-0 pointer-events-none">
      <div class="absolute top-1/4 left-1/2 -translate-x-1/2 w-[600px] h-[600px] bg-signal/5 rounded-full blur-3xl"></div>
    </div>

    <div class="container relative">
      {/* Logo mark animation */}
      <div class="flex justify-center mb-8 opacity-0 animate-fade-in">
        <div class="flex items-center gap-1 text-2xl">
          <span class="text-muted font-mono">[</span>
          <span class="w-3 h-3 bg-signal rounded-full animate-pulse-subtle"></span>
          <span class="text-muted font-mono">]</span>
        </div>
      </div>

      {/* Headline */}
      <div class="text-center max-w-2xl mx-auto">
        <h1 class="text-display text-text text-balance opacity-0 animate-fade-in-up" style="animation-delay: 100ms">
          The kernel brief<br />
          <span class="text-gradient">for builders</span>
        </h1>

        <p class="mt-6 text-h2 font-normal text-muted opacity-0 animate-fade-in-up" style="animation-delay: 200ms">
          10 ranked tech stories. Every morning. No fluff.
        </p>

        {/* Subscribe form */}
        <div class="mt-10 opacity-0 animate-fade-in-up" style="animation-delay: 300ms">
          <SubscribeForm variant="hero" />
        </div>

        {/* Micro-features */}
        <div class="mt-8 flex flex-wrap items-center justify-center gap-x-6 gap-y-2 opacity-0 animate-fade-in" style="animation-delay: 500ms">
          <span class="flex items-center gap-2 text-micro text-muted">
            <svg class="w-4 h-4 text-good" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Free forever
          </span>
          <span class="flex items-center gap-2 text-micro text-muted">
            <svg class="w-4 h-4 text-good" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            No spam
          </span>
          <span class="flex items-center gap-2 text-micro text-muted">
            <svg class="w-4 h-4 text-good" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Unsubscribe anytime
          </span>
        </div>
      </div>

      {/* Scroll indicator */}
      <div class="mt-16 flex justify-center opacity-0 animate-fade-in" style="animation-delay: 700ms">
        <a
          href="#preview"
          class="flex flex-col items-center gap-2 text-muted hover:text-signal transition-colors group"
        >
          <span class="text-micro font-mono">See today's digest</span>
          <svg class="w-5 h-5 animate-bounce" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
          </svg>
        </a>
      </div>
    </div>
  </section>

  {/* Preview Section */}
  <div id="preview">
    {previewItems.length > 0 ? (
      <DigestPreview items={previewItems} date={latestDate} />
    ) : (
      <section class="py-16 sm:py-20">
        <div class="container text-center">
          <div class="card py-12 max-w-lg mx-auto">
            <div class="flex items-center justify-center gap-2 mb-4">
              <span class="w-2 h-2 rounded-full bg-warning animate-pulse"></span>
              <span class="text-micro font-mono text-muted">No digest yet</span>
            </div>
            <p class="text-body text-muted mb-6">
              Today's digest is being prepared. Check back soon or subscribe to get it delivered.
            </p>
            <a href="/archives" class="text-signal hover:text-signal/80 transition-colors text-micro font-mono">
              View past digests â†’
            </a>
          </div>
        </div>
      </section>
    )}
  </div>

  {/* How It Works Section */}
  <HowItWorks />

  {/* Podcast Teaser Section */}
  <section class="py-16 sm:py-20 border-t border-border/30">
    <div class="container">
      <div class="max-w-2xl mx-auto">
        <div class="card p-8 sm:p-10 relative overflow-hidden">
          {/* Background accent */}
          <div class="absolute -right-10 -top-10 w-40 h-40 bg-signal/5 rounded-full blur-2xl"></div>

          <div class="relative">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-12 h-12 rounded-xl bg-signal/10 flex items-center justify-center">
                <svg class="w-6 h-6 text-signal" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                  <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                </svg>
              </div>
              <span class="px-2.5 py-1 rounded-full bg-signal/10 text-signal text-xs font-medium border border-signal/20">
                New
              </span>
            </div>

            <h3 class="text-h1 text-text mb-3">
              Prefer to listen?
            </h3>
            <p class="text-body text-muted mb-6">
              Daily 8-minute audio briefings covering the top 5 tech stories.
              Perfect for your commute, workout, or morning coffee.
            </p>

            <div class="flex flex-wrap items-center gap-4">
              <a href="/podcast" class="btn btn-primary">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M8 5v14l11-7z"/>
                </svg>
                Listen Now
              </a>
              <a href="/podcast#subscribe" class="btn btn-ghost text-signal">
                Subscribe to Podcast
              </a>
            </div>

            <div class="mt-6 flex items-center gap-4 text-xs text-muted">
              <span class="flex items-center gap-1.5">
                <svg class="w-4 h-4 text-signal" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
                </svg>
                Apple Podcasts
              </span>
              <span class="flex items-center gap-1.5">
                <svg class="w-4 h-4 text-[#1DB954]" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
                </svg>
                Spotify
              </span>
              <span class="flex items-center gap-1.5">
                <svg class="w-4 h-4 text-orange-500" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19 7.38 20 6.18 20C5 20 4 19 4 17.82a2.18 2.18 0 0 1 2.18-2.18M4 4.44A15.56 15.56 0 0 1 19.56 20h-2.83A12.73 12.73 0 0 0 4 7.27V4.44m0 5.66a9.9 9.9 0 0 1 9.9 9.9h-2.83A7.07 7.07 0 0 0 4 12.93V10.1z"/>
                </svg>
                RSS
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  {/* Bottom CTA */}
  <section class="py-16 sm:py-20">
    <div class="container">
      <div class="card text-center py-12 sm:py-16">
        <h2 class="text-h1 text-text mb-4">
          Ready to cut through the noise?
        </h2>
        <p class="text-body text-muted mb-8 max-w-md mx-auto">
          Join engineers who start their day with signal, not noise.
        </p>
        <SubscribeForm variant="hero" />
      </div>
    </div>
  </section>

  <Footer slot="footer" />
</BaseLayout>
