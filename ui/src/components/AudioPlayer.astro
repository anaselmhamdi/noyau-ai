---
interface Props {
  audioUrl: string;
  duration: string;
  issueDate: string;
}

const { audioUrl, duration, issueDate } = Astro.props;

const formattedDate = new Date(issueDate).toLocaleDateString('en-US', {
  month: 'short',
  day: 'numeric'
});
---

<div
  id="floating-player"
  class="fixed bottom-0 left-0 right-0 z-50 transform translate-y-full transition-transform duration-300"
  data-audio-url={audioUrl}
>
  <div class="bg-slate border-t border-border/50 shadow-lg">
    <div class="container py-3">
      <div class="flex items-center gap-4">
        {/* Play/Pause Button */}
        <button
          id="player-toggle"
          class="w-10 h-10 rounded-full bg-signal text-ink flex items-center justify-center hover:bg-signal/90 transition-colors flex-shrink-0"
          aria-label="Play podcast"
        >
          <svg id="play-icon" class="w-4 h-4 ml-0.5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M8 5v14l11-7z"/>
          </svg>
          <svg id="pause-icon" class="w-4 h-4 hidden" fill="currentColor" viewBox="0 0 24 24">
            <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
          </svg>
        </button>

        {/* Info & Progress */}
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 text-xs text-muted mb-1.5">
            <svg class="w-3 h-3 text-signal flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
              <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
            </svg>
            <span class="truncate">{formattedDate} &bull; {duration}</span>
          </div>

          {/* Progress Bar */}
          <div class="flex items-center gap-2">
            <div class="flex-1 h-1 bg-border/50 rounded-full overflow-hidden cursor-pointer" id="progress-bar">
              <div
                id="progress-fill"
                class="h-full bg-signal rounded-full transition-all duration-100"
                style="width: 0%"
              ></div>
            </div>
            <span id="current-time" class="text-xs font-mono text-muted w-10 text-right">0:00</span>
          </div>
        </div>

        {/* Speed Control */}
        <div class="hidden sm:flex items-center gap-2">
          <button
            id="speed-btn"
            class="px-2 py-1 text-xs font-mono text-muted bg-ink/50 rounded-lg hover:bg-ink hover:text-text transition-colors"
          >
            1x
          </button>
        </div>

        {/* Subscribe Link */}
        <a
          href="/podcast#subscribe"
          class="hidden sm:flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-signal bg-signal/10 rounded-lg hover:bg-signal/20 transition-colors flex-shrink-0"
        >
          <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
          </svg>
          Subscribe
        </a>

        {/* Close Button */}
        <button
          id="player-close"
          class="w-8 h-8 rounded-lg text-muted hover:text-text hover:bg-ink/50 flex items-center justify-center transition-colors flex-shrink-0"
          aria-label="Close player"
        >
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

{/* Hidden audio element */}
<audio id="floating-audio" preload="metadata">
  <source src={audioUrl} type="audio/mpeg" />
</audio>

<script>
  const player = document.getElementById('floating-player');
  const audio = document.getElementById('floating-audio') as HTMLAudioElement;
  const toggleBtn = document.getElementById('player-toggle');
  const playIcon = document.getElementById('play-icon');
  const pauseIcon = document.getElementById('pause-icon');
  const progressBar = document.getElementById('progress-bar');
  const progressFill = document.getElementById('progress-fill');
  const currentTimeEl = document.getElementById('current-time');
  const speedBtn = document.getElementById('speed-btn');
  const closeBtn = document.getElementById('player-close');

  const speeds = [1, 1.25, 1.5, 2, 0.75];
  let speedIndex = 0;
  let playerDismissed = false;

  function formatTime(seconds: number): string {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  function showPlayer() {
    if (!playerDismissed && player) {
      player.classList.remove('translate-y-full');
    }
  }

  function hidePlayer() {
    if (player) {
      player.classList.add('translate-y-full');
    }
  }

  // Show player after scrolling past first section
  let hasShownPlayer = false;
  window.addEventListener('scroll', () => {
    if (!hasShownPlayer && window.scrollY > 300) {
      hasShownPlayer = true;
      showPlayer();
    }
  });

  // Toggle play/pause
  toggleBtn?.addEventListener('click', () => {
    if (audio.paused) {
      audio.play();
      playIcon?.classList.add('hidden');
      pauseIcon?.classList.remove('hidden');
    } else {
      audio.pause();
      playIcon?.classList.remove('hidden');
      pauseIcon?.classList.add('hidden');
    }
  });

  // Update progress
  audio?.addEventListener('timeupdate', () => {
    if (audio.duration) {
      const progress = (audio.currentTime / audio.duration) * 100;
      if (progressFill) progressFill.style.width = `${progress}%`;
      if (currentTimeEl) currentTimeEl.textContent = formatTime(audio.currentTime);
    }
  });

  // Seek on progress bar click
  progressBar?.addEventListener('click', (e) => {
    const rect = progressBar.getBoundingClientRect();
    const percent = (e.clientX - rect.left) / rect.width;
    if (audio.duration) {
      audio.currentTime = percent * audio.duration;
    }
  });

  // Speed control
  speedBtn?.addEventListener('click', () => {
    speedIndex = (speedIndex + 1) % speeds.length;
    const speed = speeds[speedIndex];
    audio.playbackRate = speed;
    speedBtn.textContent = `${speed}x`;
  });

  // Close player
  closeBtn?.addEventListener('click', () => {
    playerDismissed = true;
    audio.pause();
    hidePlayer();
  });

  // Handle audio ending
  audio?.addEventListener('ended', () => {
    playIcon?.classList.remove('hidden');
    pauseIcon?.classList.add('hidden');
  });
</script>

<style>
  #floating-player {
    /* Safe area for mobile devices with home indicator */
    padding-bottom: env(safe-area-inset-bottom);
  }
</style>
