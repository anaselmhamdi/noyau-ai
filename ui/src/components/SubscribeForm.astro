---
interface Props {
  variant?: 'default' | 'hero';
  issueDate?: string;
}

const { variant = 'default', issueDate } = Astro.props;
const isHero = variant === 'hero';
const formLocation = isHero ? 'hero' : 'footer';
---

<div
  id="subscribe"
  class={isHero ? 'max-w-md mx-auto' : ''}
  data-form-location={formLocation}
  data-issue-date={issueDate || ''}
>
  <form
    action="/auth/subscribe"
    method="POST"
    class={`flex ${isHero ? 'flex-col sm:flex-row' : ''} gap-3`}
    id="subscribe-form"
  >
    <div class="relative flex-1">
      <input
        type="email"
        name="email"
        placeholder="you@company.com"
        required
        autocomplete="email"
        class={`input ${isHero ? 'text-center sm:text-left' : ''}`}
        id="subscribe-email"
      />
      {/* Hidden fields for timezone - auto-filled by JS */}
      <input type="hidden" name="timezone" id="subscribe-timezone" />
      <input type="hidden" name="delivery_time_local" id="subscribe-delivery-time" value="08:00" />
      {/* Email icon */}
      <div class="absolute left-4 top-1/2 -translate-y-1/2 pointer-events-none hidden sm:block">
        <svg class="w-4 h-4 text-muted/50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
        </svg>
      </div>
    </div>
    <button type="submit" class="btn btn-primary whitespace-nowrap">
      <span>Get the brief</span>
      <svg class="w-4 h-4 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
      </svg>
    </button>
  </form>
  {/* Timezone confirmation - shown after detection */}
  <div id="timezone-info" class={`mt-2 text-xs text-muted text-center ${isHero ? '' : 'hidden'}`}>
    <span id="timezone-text"></span>
  </div>

  {/* Success/Error messages would be handled by JS */}
  <div id="subscribe-message" class="mt-3 text-center text-body hidden">
    <p class="text-good" id="subscribe-success">Check your inbox for the magic link.</p>
    <p class="text-bad" id="subscribe-error">Something went wrong. Please try again.</p>
  </div>
</div>

<script>
  import { trackSignupFormShown, trackSignupStarted } from '../lib/posthog';

  const container = document.getElementById('subscribe');
  const form = document.getElementById('subscribe-form') as HTMLFormElement;
  const emailInput = document.getElementById('subscribe-email') as HTMLInputElement;
  const timezoneInput = document.getElementById('subscribe-timezone') as HTMLInputElement;
  const deliveryTimeInput = document.getElementById('subscribe-delivery-time') as HTMLInputElement;
  const timezoneInfo = document.getElementById('timezone-info');
  const timezoneText = document.getElementById('timezone-text');
  const messageDiv = document.getElementById('subscribe-message');
  const successMsg = document.getElementById('subscribe-success');
  const errorMsg = document.getElementById('subscribe-error');
  const submitBtn = form?.querySelector('button[type="submit"]') as HTMLButtonElement;
  const btnText = submitBtn?.querySelector('span');

  // Detect and set user's timezone
  function detectTimezone(): string {
    try {
      return Intl.DateTimeFormat().resolvedOptions().timeZone;
    } catch {
      return 'UTC';
    }
  }

  // Format timezone for display (e.g., "America/New_York" -> "New York")
  function formatTimezone(tz: string): string {
    return tz.split('/').pop()?.replace(/_/g, ' ') || tz;
  }

  // Initialize timezone detection
  if (timezoneInput) {
    const detectedTz = detectTimezone();
    timezoneInput.value = detectedTz;

    // Show timezone info on hero variant
    if (timezoneInfo && timezoneText && container?.dataset.formLocation === 'hero') {
      timezoneText.textContent = `Delivered at 8:00 AM ${formatTimezone(detectedTz)} time`;
      timezoneInfo.classList.remove('hidden');
    }
  }

  if (container && form && emailInput) {
    const formLocation = container.dataset.formLocation as 'hero' | 'footer';
    const issueDate = container.dataset.issueDate || undefined;

    // Track form visibility with IntersectionObserver
    let formShownTracked = false;
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting && !formShownTracked) {
          formShownTracked = true;
          trackSignupFormShown('page_load', issueDate);
        }
      });
    }, { threshold: 0.5 });

    observer.observe(container);

    // Handle form submission with JSON
    let signupStartedTracked = false;
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = emailInput.value;
      if (!email) return;

      // Track analytics
      if (!signupStartedTracked) {
        signupStartedTracked = true;
        trackSignupStarted(email, formLocation, issueDate);
      }

      // Update UI to loading state
      if (submitBtn) submitBtn.disabled = true;
      if (btnText) btnText.textContent = 'Sending...';
      if (messageDiv) messageDiv.classList.add('hidden');
      if (successMsg) successMsg.classList.add('hidden');
      if (errorMsg) errorMsg.classList.add('hidden');

      // Build request with timezone
      const requestBody: Record<string, string> = {
        email,
        redirect: '/welcome',
      };

      if (timezoneInput?.value) {
        requestBody.timezone = timezoneInput.value;
      }
      if (deliveryTimeInput?.value) {
        requestBody.delivery_time_local = deliveryTimeInput.value;
      }

      try {
        const response = await fetch('/auth/subscribe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody),
        });

        if (response.ok) {
          const data = await response.json();
          // Redirect to welcome page
          window.location.href = data.redirect || '/welcome';
        } else {
          // Show error message
          if (messageDiv) messageDiv.classList.remove('hidden');
          if (errorMsg) errorMsg.classList.remove('hidden');
          if (submitBtn) submitBtn.disabled = false;
          if (btnText) btnText.textContent = 'Get the brief';
        }
      } catch (err) {
        // Network error
        if (messageDiv) messageDiv.classList.remove('hidden');
        if (errorMsg) errorMsg.classList.remove('hidden');
        if (submitBtn) submitBtn.disabled = false;
        if (btnText) btnText.textContent = 'Get the brief';
      }
    });
  }
</script>

<style>
  /* Add padding for email icon on larger screens */
  @media (min-width: 640px) {
    #subscribe-email {
      padding-left: 2.75rem;
    }
  }
</style>
